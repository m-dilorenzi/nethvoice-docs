name: Sync Documentation Translations

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'
      - 'i18n/it/docusaurus-plugin-content-docs/current/**/*.md'
      - 'i18n/it/docusaurus-plugin-content-docs/current/**/*.mdx'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  models: read

jobs:
  sync-translations:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests PyYAML gitpython

      - name: Analyze changed documentation files
        id: analyze-files
        run: |
          # Get the list of commits in this PR
          git fetch origin main
          git fetch origin ${{ github.event.pull_request.head.ref }}
          
          echo "ğŸ” Debug: Branch information:"
          echo "Target branch: ${{ github.event.pull_request.base.ref }}"
          echo "Source branch: ${{ github.event.pull_request.head.ref }}"
          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "Main branch: $(git rev-parse origin/main)"
          
          # Get the last workflow run on this branch to find the last processed commit
          echo ""
          echo "ğŸ” Checking for previous workflow executions..."
          
          LAST_WORKFLOW_COMMIT=""
          
          # Use GitHub API to get the last successful run of this workflow on this branch
          WORKFLOW_RUNS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-translations.yml/runs?branch=${{ github.event.pull_request.head.ref }}&per_page=5")
          
          # Extract the head_commit SHA from the last successful completed run
          LAST_WORKFLOW_COMMIT=$(echo "$WORKFLOW_RUNS" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          runs = data.get('workflow_runs', [])
          # Find the most recent completed run (excluding current run)
          for run in runs:
            if run['status'] == 'completed':
              print(run['head_commit']['id'])
              break
          " 2>/dev/null || echo "")
          
          if [ -n "$LAST_WORKFLOW_COMMIT" ]; then
            echo "âœ… Found last workflow execution at commit: $LAST_WORKFLOW_COMMIT"
            # Use the commit after the last processed one as the range start
            COMMITS_RANGE="$LAST_WORKFLOW_COMMIT..HEAD"
          else
            echo "âš ï¸  No previous workflow execution found, using merge-base"
            MERGE_BASE=$(git merge-base origin/${{ github.event.pull_request.base.ref }} HEAD)
            COMMITS_RANGE="$MERGE_BASE..HEAD"
            echo "ğŸ“ Merge base: $MERGE_BASE"
          fi
          
          # Get list of commits in chronological order (oldest first)
          COMMITS=$(git rev-list --reverse $COMMITS_RANGE)
          
          if [ -z "$COMMITS" ]; then
            echo "âœ… No new commits found to process"
            echo "needs-translation=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo ""
          echo "ğŸ“ Commits to process:"
          echo "$COMMITS" | while read commit; do
            echo "  - $(git log --oneline -1 $commit)"
          done
          
          # Determine PR primary language by analyzing commits until we find a clear majority
          echo ""
          echo "ğŸ” Determining PR primary language from commits..."
          
          PR_LANGUAGE=""
          COMMIT_INDEX=0
          
          # Save commits to array to avoid subshell issues with pipes
          mapfile -t COMMITS_ARRAY <<< "$COMMITS"
          
          # Iterate through commits until we determine a language
          for check_commit in "${COMMITS_ARRAY[@]}"; do
            COMMIT_INDEX=$((COMMIT_INDEX + 1))
            
            if [ -n "$PR_LANGUAGE" ]; then
              # Language already determined, stop
              break
            fi
            
            echo "  âœ“ Checking commit $COMMIT_INDEX: $(git log --oneline -1 $check_commit)"
            
            # Get files changed in this commit - using simpler pattern matching
            COMMIT_FILES=$(git diff-tree --no-commit-id --name-only -r $check_commit)
            
            if [ -z "$COMMIT_FILES" ]; then
              echo "    â­ï¸  No documentation files, checking next commit..."
              continue
            fi
            
            # Check files in this commit
            EN_FILES=$(echo "$COMMIT_FILES" | grep "^docs/" || true)
            IT_FILES=$(echo "$COMMIT_FILES" | grep "^i18n/it/" || true)
            
            if [ -z "$EN_FILES" ] && [ -z "$IT_FILES" ]; then
              echo "    â­ï¸  No documentation files, checking next commit..."
              continue
            elif [ -n "$EN_FILES" ] && [ -z "$IT_FILES" ]; then
              # Only English files
              PR_LANGUAGE="EN"
              echo "    âœ… Only EN files found"
              echo "ğŸ“Œ PR primary language: English (EN) - determined from commit $COMMIT_INDEX"
              break
            elif [ -z "$EN_FILES" ] && [ -n "$IT_FILES" ]; then
              # Only Italian files
              PR_LANGUAGE="IT"
              echo "    âœ… Only IT files found"
              echo "ğŸ“Œ PR primary language: Italian (IT) - determined from commit $COMMIT_INDEX"
              break
            else
              # Both languages present - check majority
              EN_COUNT=$(echo "$EN_FILES" | wc -l)
              IT_COUNT=$(echo "$IT_FILES" | wc -l)
              
              echo "    ğŸ“Š Found $EN_COUNT EN files and $IT_COUNT IT files"
              
              if [ "$EN_COUNT" -gt "$IT_COUNT" ]; then
                PR_LANGUAGE="EN"
                echo "    âœ… EN majority ($EN_COUNT > $IT_COUNT)"
                echo "ğŸ“Œ PR primary language: English (EN) - determined from commit $COMMIT_INDEX"
                break
              elif [ "$IT_COUNT" -gt "$EN_COUNT" ]; then
                PR_LANGUAGE="IT"
                echo "    âœ… IT majority ($IT_COUNT > $EN_COUNT)"
                echo "ğŸ“Œ PR primary language: Italian (IT) - determined from commit $COMMIT_INDEX"
                break
              else
                # Equal - continue to next commit
                echo "    âš ï¸  Equal files ($EN_COUNT each), checking next commit..."
                continue
              fi
            fi
          done
          
          # Check if we managed to determine a language
          if [ -z "$PR_LANGUAGE" ]; then
            echo ""
            echo "âš ï¸ Could not determine PR primary language from any commit"
            echo "âš ï¸ All commits have equal EN/IT files - skipping automatic translation"
            echo "needs-translation=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Function to map English file to Italian equivalent
          map_en_to_it() {
            local en_file="$1"
            echo "${en_file/docs\//i18n\/it\/docusaurus-plugin-content-docs\/current\/}"
          }
          
          # Function to map Italian file to English equivalent  
          map_it_to_en() {
            local it_file="$1"
            echo "${it_file/i18n\/it\/docusaurus-plugin-content-docs\/current\//docs\/}"
          }
          
          # Process each commit
          echo ""
          echo "ğŸ”„ Processing commits one by one..."
          
          # Clear the files list
          > /tmp/commits-needing-translation.json
          
          for commit in "${COMMITS_ARRAY[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Processing commit: $(git log --oneline -1 $commit)"
            
            # Get files changed in this specific commit
            COMMIT_FILES=$(git diff-tree --no-commit-id --name-only -r $commit)
            
            if [ -z "$COMMIT_FILES" ]; then
              echo "  â­ï¸  No documentation files in this commit"
              continue
            fi
            
            echo "  ğŸ“„ Files in commit:"
            echo "$COMMIT_FILES" | sed 's/^/    - /'
            
            # Analyze files in this commit - check each file individually
            echo "  ğŸ¤– Analyzing files for translation needs..."
            
            # Convert COMMIT_FILES to array for easier checking
            COMMIT_FILES_ARRAY=($COMMIT_FILES)
            
            for file in $COMMIT_FILES; do
              if [ -n "$file" ]; then
                # Determine counterpart file path and check language
                if [[ "$file" == docs/* ]]; then
                  counterpart=$(map_en_to_it "$file")
                  direction="EN â†’ IT"
                  file_lang="EN"
                elif [[ "$file" == i18n/it/docusaurus-plugin-content-docs/current/* ]]; then
                  counterpart=$(map_it_to_en "$file")
                  direction="IT â†’ EN"
                  file_lang="IT"
                else
                  # Not a documentation file, skip
                  continue
                fi
                
                # Check if this file's language matches PR primary language
                if [ "$file_lang" != "$PR_LANGUAGE" ]; then
                  echo "    â­ï¸  Skipping $file - not in primary language ($PR_LANGUAGE)"
                  continue
                fi
                
                # Check if counterpart was also modified in this same commit
                if [[ " ${COMMIT_FILES_ARRAY[*]} " =~ " ${counterpart} " ]]; then
                  echo "    âœ… Both files in commit ($direction): $file â†” $counterpart - skipping (manual translation)"
                else
                  echo "    ğŸ”„ Need translation ($direction): $file â†’ $counterpart"
                  # Store commit hash and file in JSON format
                  echo "{\"commit\":\"$commit\",\"file\":\"$file\"}" >> /tmp/commits-needing-translation.json
                fi
              fi
            done
          done
          
          # Check if we have any files to translate
          if [ -f /tmp/commits-needing-translation.json ] && [ -s /tmp/commits-needing-translation.json ]; then
            echo ""
            echo "âœ… Analysis completed - found files needing translation"
            echo "needs-translation=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… Analysis completed - no translation needed"
            echo "needs-translation=false" >> $GITHUB_OUTPUT
          fi

      - name: Test GitHub Models API access
        if: steps.analyze-files.outputs.needs-translation == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Testing GitHub Models API connectivity..."
          python .github/scripts/translation-agent/test-copilot-access.py
          echo "âœ… API test passed, proceeding with translation sync"

      - name: Run translation sync
        if: steps.analyze-files.outputs.needs-translation == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read commit-file pairs that need translation
          if [ ! -f /tmp/commits-needing-translation.json ]; then
            echo "âŒ No translation data file found"
            exit 1
          fi
          
          echo "ğŸ¤– Running translation agent for commits..."
          echo ""
          
          # Process each commit-file pair
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              commit=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['commit'])")
              file=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['file'])")
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“¦ Commit: $(git log --oneline -1 $commit)"
              echo "ï¿½ File: $file"
              echo ""
              
              python .github/scripts/translation-agent/translation-sync-agent.py "$file" "$commit"
              
              echo ""
            fi
          done < /tmp/commits-needing-translation.json
          
          echo "âœ… All translations completed."
        continue-on-error: false

      - name: Check for changes and commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Translation Sync Bot"
          
          # Check if there are any changes to commit (modified files, new files, or deleted files)
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… No translation changes needed"
          else
            # Show what files were modified or added
            echo "ğŸ“ Files with translation changes:"
            git status --porcelain
            
            # Add all changes and commit
            git add .
            
            # Count modified files for commit message
            MODIFIED_COUNT=$(git diff --cached --name-only | wc -l)
            
            git commit -m "docs: auto-sync translations for PR #${{ github.event.pull_request.number }}"
            
            git push
            echo "âœ… Translation changes committed and pushed ($MODIFIED_COUNT files)"
          fi